console.log("Hola Mundo");document.addEventListener("DOMContentLoaded",function(){let P=[],g=document.getElementById("ListaProductos"),E=document.getElementById("escaner"),L=document.querySelector(".head-text .text-danger");document.querySelectorAll(".producto-card").forEach(t=>{let o=t.getAttribute("data-id"),e=productos.find(n=>n.Id_Producto==o);e&&(t.setAttribute("data-stock",e.Stock),e.Stock<=0?(t.classList.add("producto-agotado"),t.innerHTML+='<div class="agotado-badge">AGOTADO</div>',t.style.opacity="0.6",t.style.pointerEvents="none"):t.addEventListener("click",function(){h(e),l(),u()}))});function u(){const o=Array.from(document.querySelectorAll("#ListaProductos .producto")).map(e=>({id:e.getAttribute("data-id"),cantidad:parseInt(e.querySelector(".cantidad").value)||0})).reduce((e,n)=>(e[n.id]=(e[n.id]||0)+n.cantidad,e),{});document.querySelectorAll(".producto-card").forEach(e=>{const n=e.getAttribute("data-id"),a=parseInt(e.getAttribute("data-stock"))-(o[n]||0),c=e.querySelector(".agotado-badge");a<=0?(c||(e.innerHTML+='<div class="agotado-badge">¡AGOTADO!</div>'),e.classList.add("producto-agotado"),e.style.opacity="0.6",e.style.pointerEvents="none"):(c&&c.remove(),e.classList.remove("producto-agotado"),e.style.opacity="1",e.style.pointerEvents="auto")})}E.addEventListener("keypress",function(t){if(t.key==="Enter"){t.preventDefault();let o=E.value.trim();if(o==="")return;let e=productos.find(n=>n.barcode==o);e?(h(e),l()):alert("Producto no encontrado"),E.value=""}}),$(".cargaElementos").on("click",function(){let t=document.getElementById("print-receipt-table");t.innerHTML="",document.querySelectorAll("#ListaProductos .producto").forEach(c=>{let s=c.getAttribute("data-id"),r=productos.find(i=>i.Id_Producto==s);if(r){let i=parseInt(c.querySelector(".cantidad").value)||1,m=(r.Precio_Venta-r.Precio_Venta*(r.descuento/100))*i,y=`
                    <tr>
                        <td>${r.Nombre_Producto}</td>
                        <td>₡${r.Precio_Venta} ${r.descuento>0?'<span style="color: green;">-'+r.descuento+"%</span>":""} </td>
                        <td>${i}</td>
                        <td class="text-end">₡${m.toFixed(2)}</td>
                    </tr>
                `;t.insertAdjacentHTML("beforeend",y)}});let o=0,e=0;document.querySelectorAll("#ListaProductos .producto").forEach(c=>{let s=c.getAttribute("data-id"),r=productos.find(i=>i.Id_Producto==s);if(r){let i=parseInt(c.querySelector(".cantidad").value)||1,v=r.Precio_Venta*i,m=r.Precio_Venta*(r.descuento/100)*i;o+=v,e+=m}});let n=document.getElementById("subtotalRecibo");n&&(n.textContent="₡ "+o.toLocaleString());let d=document.getElementById("descuentoRecibo");d&&(d.textContent="-₡ "+e.toLocaleString());let a=document.getElementById("TotalCompraRecibo");a&&(a.textContent="₡ "+(o-e).toLocaleString()),document.querySelectorAll("#ListaProductos .producto").length>0?document.querySelector(".methods .item a.selected")?$("#print-receipt").modal("show"):Swal.fire({icon:"warning",title:"Método de pago no seleccionado",text:"Por favor, seleccione un método de pago antes de imprimir el recibo."}):Swal.fire({icon:"warning",title:"No hay productos",text:"No hay productos en la lista para imprimir el recibo."})}),document.getElementById("imprimirRecibo").addEventListener("click",function(){let t=document.getElementById("reciboaImprimir").outerHTML,o=document.body.innerHTML;document.body.innerHTML=`
            <html>
                <head>
                    <title>Recibo</title>
                    <style>
                        /* Aquí puedes agregar estilos personalizados para el PDF */
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            
                            padding: 8px;
                            text-align: left;
                        }
                    </style>
                </head>
                <body>
                    ${t}
                </body>
            </html>
        `,window.print(),document.body.innerHTML=o,location.reload()}),document.getElementById("procesarPago").addEventListener("click",function(t){var d;const o=document.querySelector(".methods a.selected");if(!o){Swal.fire({icon:"warning",title:"Método de pago no seleccionado",text:"Por favor, seleccione un método de pago antes de imprimir el recibo."});return}const e=parseInt(o.getAttribute("data-id"))||0;if(e===0||e>3){alert("Método de pago inválido o no seleccionado");return}Array.from(document.querySelectorAll("#ListaProductos .producto"));const n={productos:Array.from(document.querySelectorAll("#ListaProductos .producto")).map(a=>({id:parseInt(a.getAttribute("data-id")),cantidad:parseInt(a.querySelector(".cantidad").value)})),metodo_pago_id:parseInt(((d=document.querySelector(".methods a.selected"))==null?void 0:d.getAttribute("data-id"))||0),total:parseFloat(document.getElementById("totalPagar").textContent.replace(/[^\d.]/g,"")),cedula:b};console.log("Enviando payload:",n),console.log("Cédula enviada:",n.cedula),fetch("/completar-venta",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(n)}).then(a=>a.ok?a.json():a.text().then(c=>{throw new Error(c)})).then(a=>console.log("Respuesta:",a)).catch(a=>console.error("Error:",a.message))}),document.querySelectorAll(".methods a.metodo-pago").forEach(t=>{t.addEventListener("click",function(o){o.preventDefault(),document.querySelectorAll(".methods a.metodo-pago").forEach(e=>{e.classList.remove("selected")}),this.classList.add("selected")})});function h(t){let o=document.querySelector(`#ListaProductos .producto[data-id="${t.Id_Producto}"]`);if(t.Stock<=0){Swal.fire({icon:"error",title:"Producto agotado",text:`El producto ${t.Nombre_Producto} está agotado y no puede ser vendido.`});return}if(o){let e=o.querySelector(".cantidad");e.value=parseInt(e.value)+1}else{let e=t.Precio_Venta-t.Precio_Venta*(t.descuento/100),n=`
                <div class="product-list d-flex align-items-center justify-content-between producto" data-id="${t.Id_Producto}">
                    <div class="d-flex align-items-center product-info">
                        <a href="javascript:void(0);" class="img-bg">
                            <img src="${t.imagen||"https://icons.veryicon.com/png/o/miscellaneous/fu-jia-intranet/product-29.png"}" alt="Producto">
                        </a>
                        <div class="info">
                            <span>${t.barcode}</span>
                            <h6><a href="javascript:void(0);">${t.Nombre_Producto}</a></h6>
                            ${t.descuento>0?`<span class="bg-success text-dark bg-opacity-50">₡ ${t.Precio_Venta} - ${t.descuento}%</span>`:""}
                            <p>₡ ${e}</p>
                            <p class="puntos-obtenidos"></p> <!-- Espacio para mostrar puntos obtenidos -->
                        </div>
                    </div>
                    <div class="qty-item text-center">
                        <a href="javascript:void(0);" class="dec"><i data-feather="minus-circle" class="feather-14"></i></a>
                        <input type="text" class="form-control text-center cantidad" value="1">
                        <a href="javascript:void(0);" class="inc"><i data-feather="plus-circle" class="feather-14"></i></a>
                    </div>
                    <div class="d-flex align-items-center action">
                        <a class="btn-icon delete-icon confirm-text" href="javascript:void(0);">
                            <i data-feather="trash-2" class="feather-14"></i>
                        </a>
                    </div>
                </div>
            `;g.insertAdjacentHTML("beforeend",n),feather.replace(),P.push({id:t.Id_Producto,cantidad:1})}fetch(`/producto/${t.Id_Producto}/puntos`).then(e=>e.json()).then(e=>{if(e.success){p.set(t.Id_Producto,e.puntos_obtenidos),S();let d=document.querySelector(`#ListaProductos .producto[data-id="${t.Id_Producto}"]`).querySelector(".puntos-obtenidos");d.textContent=`Gana ${e.puntos_obtenidos} puntos`}else console.log(e.message)}).catch(e=>console.log("Error al obtener puntos:",e)),f()}document.querySelector("#ListaProductos").addEventListener("click",function(t){if(t.target.closest(".delete-icon")){const o=t.target.closest(".producto"),e=parseInt(o.getAttribute("data-id"));p.delete(e),S()}}),g.addEventListener("click",function(t){if(t.target.closest(".delete-icon")){let o=t.target.closest(".producto");o&&(o.remove(),l(),u())}if(t.target.closest(".inc")){let e=t.target.closest(".producto").querySelector(".cantidad");e.value=parseInt(e.value)+1,l(),u()}if(t.target.closest(".dec")){let e=t.target.closest(".producto").querySelector(".cantidad"),n=parseInt(e.value)-1;n>=1&&(e.value=n),l(),u()}}),L.addEventListener("click",function(){Swal.fire({title:"¿Estás seguro?",text:"¡Esto eliminará todos los productos de la lista!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar todo",cancelButtonText:"Cancelar"}).then(t=>{t.isConfirmed&&(g.innerHTML="",l(),u(),Swal.fire("¡Eliminado!","Todos los productos han sido eliminados.","success"))})});function l(){let t=0;g.querySelectorAll(".producto").forEach(e=>{let n=parseInt(e.querySelector(".cantidad").value)||0;t+=n}),contadorArticulos.textContent=t}function f(){let t=0,o=0;document.querySelectorAll("#ListaProductos .producto").forEach(c=>{var y;let s=parseInt(c.querySelector(".cantidad").value)||1,r=c.querySelector("p"),i=parseFloat(r.textContent.replace(/[₡$,]/g,""))||0,m=(parseFloat((y=c.querySelector(".bg-success"))==null?void 0:y.textContent.split("₡")[1])||i)-i;o+=m*s,t+=i*s});let n=document.getElementById("totalCompra");n&&(n.textContent="₡ "+t.toLocaleString());let d=document.getElementById("totalDescuento");d&&(d.textContent="-₡ "+o.toLocaleString());let a=document.getElementById("totalPagar");a&&(a.textContent="Total A Pagar: ₡ "+t.toLocaleString())}document.querySelector("#ListaProductos").addEventListener("input",function(t){t.target.classList.contains("cantidad")&&f()}),document.querySelector("#ListaProductos").addEventListener("click",function(t){let o=t.target;(o.closest(".delete-icon")||o.closest(".inc")||o.closest(".dec"))&&f()}),f();let p=new Map,b=null;function S(){let t=0;document.querySelectorAll("#ListaProductos .producto").forEach(o=>{const e=parseInt(o.getAttribute("data-id")),n=parseInt(o.querySelector(".cantidad").value),d=p.get(e)||0;t+=d*n}),document.getElementById("totalPuntos").textContent=t}document.querySelector(".btn-warning").addEventListener("click",()=>{p.size>0&&$("#puntosModal").modal("show")}),document.getElementById("formPuntos").addEventListener("submit",function(t){t.preventDefault();const o=document.getElementById("cedula").value.replace(/[^0-9]/g,"");fetch("/check-user",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({cedula:o})}).then(e=>e.json()).then(e=>{e.exists?(b=o,$("#puntosModal").modal("hide")):Swal.fire("Error","Usuario no encontrado","error")})}),document.getElementById("abrirModalPuntosBtn").addEventListener("click",()=>{p.size>0&&$("#puntosModal").modal("show")})});
